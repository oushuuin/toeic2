<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>自动识别答题系统</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    #video {
      width: 100%;
      max-width: 400px;
      border: 1px solid #ccc;
    }
    #gptAnswer {
      white-space: pre-wrap;
      border: 1px solid #ccc;
      padding: 10px;
      margin-top: 10px;
      background: #f9f9f9;
    }
    #startBtn {
      padding: 10px 20px;
      font-size: 16px;
    }
  </style>
</head>
<body>

  <h2>AI 拍照答题系统</h2>
  <button id="startBtn">🚀 启用语音和摄像头</button><br><br>

  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" style="display:none;"></canvas>

  <h3>GPT 回答：</h3>
  <div id="gptAnswer">请点击按钮开始...</div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>

  <script>
    const API_KEY = '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'; // 替换为你的 OpenAI API Key
    const API_URL = 'https://api.openai.com/v1/chat/completions';

    const startBtn = document.getElementById('startBtn');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const gptAnswer = document.getElementById('gptAnswer');

    let voiceEnabled = false;
    let enVoice = null;
    let videoStream = null;
    let autoCaptureEnabled = false;
    let isCoolingDown = false;

    function initVoice() {
      const voices = speechSynthesis.getVoices();
      if (voices.length > 0) {
        enVoice = voices.find(v => v.lang === 'en-US') || voices[0];
        voiceEnabled = true;
      }
    }

    function speak(text) {
      if (!voiceEnabled || !text) return;
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'en-US';
      utter.voice = enVoice;
      speechSynthesis.speak(utter);
    }

    async function startCamera() {
      try {
        videoStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' },
          audio: false
        });
        video.srcObject = videoStream;
        autoCaptureEnabled = true;
        detectBrightnessLoop();
      } catch (err) {
        alert('摄像头权限获取失败');
        console.error(err);
      }
    }

    function getFrameBrightness() {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
      let total = 0;
      for (let i = 0; i < frame.data.length; i += 4) {
        const r = frame.data[i];
        const g = frame.data[i + 1];
        const b = frame.data[i + 2];
        const brightness = (r + g + b) / 3;
        total += brightness;
      }
      const avg = total / (frame.data.length / 4);
      return avg;
    }

    let lastDark = true;

    function detectBrightnessLoop() {
      if (!autoCaptureEnabled) return;

      const brightness = getFrameBrightness();
      const isDark = brightness < 40;

      // 如果原来是暗的，现在变亮，开始延迟5秒拍照
      if (lastDark && !isDark && !isCoolingDown) {
        console.log('检测到亮起，5秒后拍照');
        isCoolingDown = true;
        setTimeout(() => {
          if (!getFrameBrightness() < 40) {
            captureAndProcess();
          } else {
            console.log('亮度变化取消拍照（变暗）');
          }
          isCoolingDown = false;
        }, 5000);
      }

      lastDark = isDark;
      setTimeout(detectBrightnessLoop, 1000);
    }

    async function captureAndProcess() {
      gptAnswer.textContent = '识别中...';

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const blob = await new Promise(resolve =>
        canvas.toBlob(resolve, 'image/jpeg', 0.9)
      );

      try {
        const result = await Tesseract.recognize(blob, 'chi_sim+eng');
        const text = result.data.text.trim();

        const messages = [
          {
            role: 'system',
            content: '做出toeic英语题的答案，按顺序给出的正确选项（仅回答a或b或c或d即可，不要回答后面具体的选项内容）'
          },
          {
            role: 'user',
            content: text
          }
        ];

        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${API_KEY}`
          },
          body: JSON.stringify({
            model: 'gpt-3.5-turbo',
            messages
          })
        });

        const data = await response.json();
        const answer = data.choices?.[0]?.message?.content?.trim() || '无回答';
        gptAnswer.textContent = answer;
        speak(answer);
      } catch (err) {
        console.error(err);
        gptAnswer.textContent = '识别失败';
      }
    }

    // 按钮启动语音和摄像头
    startBtn.addEventListener('click', () => {
      initVoice();
      speak('Voice enabled');
      startCamera();
      startBtn.disabled = true;
      startBtn.textContent = '✅ 已启用';
    });

    // iOS语音必须点击交互才能启用
    speechSynthesis.getVoices();
    if (speechSynthesis.onvoiceschanged !== undefined) {
      speechSynthesis.onvoiceschanged = initVoice;
    }
  </script>
</body>
</html>